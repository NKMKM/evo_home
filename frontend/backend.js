import express from 'express';
import cors from 'cors';
import session from 'express-session';
import { Pool } from 'pg';

const app = express();
const PORT = 3001;

// ðŸ”“ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Aiven PostgreSQL Ñ SSL
const pool = new Pool({
  user: 'avnadmin',
  host: 'evohome-ateuhen.c.aivencloud.com',
  database: 'defaultdb',
  password: 'AVNS_vQW4aZoDSamdjlpy4E-',
  port: 24616,
  ssl: {
    rejectUnauthorized: false
  }
});

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ
pool.connect()
  .then(client => {
    console.log('âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾');
    client.release();
  })
  .catch(err => {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ:', err.message);
  });

// â— Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð’Ð¡Ð• origin'Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
app.use(cors({
  origin: true, // Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð»ÑŽÐ±Ð¾Ð¹ origin
  credentials: true
}));

// ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° JSON
app.use(express.json());

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑÑÐ¸Ð¹
app.use(session({
  secret: 'evo_home_dev_secret',
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: false, // Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ false Ð´Ð»Ñ HTTP
    maxAge: 24 * 60 * 60 * 1000
  }
}));

// ðŸ” Ð›Ð¾Ð³Ð¸Ð½
app.post('/api/login', async (req, res) => {
  const { username, password } = req.body;

  try {
    const result = await pool.query(
      'SELECT * FROM users WHERE username = $1 AND password = $2',
      [username, password]
    );

    if (result.rows.length > 0) {
      req.session.user = { username: result.rows[0].username };
      console.log('âœ… Ð’Ñ…Ð¾Ð´:', result.rows[0].username);
      res.json({ success: true });
    } else {
      console.log('âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½');
      res.status(401).json({ success: false, message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }
  } catch (err) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð»Ð¾Ð³Ð¸Ð½Ð°:', err.message);
    res.status(500).json({ success: false, message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…' });
  }
});

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
app.get('/api/check-auth', (req, res) => {
  res.json({
    authenticated: !!req.session.user,
    user: req.session.user || null
  });
});

// Ð’Ñ‹Ñ…Ð¾Ð´
app.post('/api/logout', (req, res) => {
  req.session.destroy(() => {
    res.json({ success: true });
  });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});
